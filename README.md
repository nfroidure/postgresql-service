[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# postgresql-service
> A simple wrapper around `node-pg`

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/postgresql-service/blob/master/LICENSE)
[![Build status](https://secure.travis-ci.org/nfroidure/postgresql-service.svg)](https://travis-ci.org/nfroidure/postgresql-service)
[![Coverage Status](https://coveralls.io/repos/nfroidure/postgresql-service/badge.svg?branch=master)](https://coveralls.io/r/nfroidure/postgresql-service?branch=master)
[![NPM version](https://badge.fury.io/js/postgresql-service.svg)](https://npmjs.org/package/postgresql-service)
[![Dependency Status](https://david-dm.org/nfroidure/postgresql-service.svg)](https://david-dm.org/nfroidure/postgresql-service)
[![devDependency Status](https://david-dm.org/nfroidure/postgresql-service/dev-status.svg)](https://david-dm.org/nfroidure/postgresql-service#info=devDependencies)
[![Package Quality](http://npm.packagequality.com/shield/postgresql-service.svg)](http://packagequality.com/#?package=postgresql-service)
[![Code Climate](https://codeclimate.com/github/nfroidure/postgresql-service.svg)](https://codeclimate.com/github/nfroidure/postgresql-service)


[//]: # (::contents:start)

This simple service covers my own usage of the `pg` module. I only
 use transactions and queries and I use dependency injection with
 [Knifecycle](https://github.com/nfroidure/knifecycle).

It also sets up a few tweaks I have to do for each projects like
 avoiding to mess up with dates.

## Tagged templates

This module also export a tagged template function you can use
 like that:
```ts
import sql, {
  escapeSQLIdentifier,
  sqlPart,
  emptySQLPart,
} from 'postgresql-service';

const limit = 10;
const query = sql`SELECT id FROM users WHERE name=${'toto'} ${
  limit ?
  sqlPart`LIMIT ${limit}` :
  emptySQLPart
}`;
const query2 = sql`SELECT id FROM ${escapeSQLIdentifier('table')}`;
const query3 = sql`SELECT id FROM users WHERE id IN ${
  joinSQLValues([1, 2])
}}`;
const mergedQuery = `
${query}
UNION
${query2}
UNION
${query3}
`;
```

[//]: # (::contents:end)

# API
## Members

<dl>
<dt><a href="#default">default</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Instantiate the pg service mock</p>
</dd>
</dl>

## Functions

<dl>
<dt><a href="#initPGService">initPGService(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Instantiate the pg service</p>
</dd>
</dl>

<a name="default"></a>

## default ⇒ <code>Promise.&lt;Object&gt;</code>
Instantiate the pg service mock

**Kind**: global variable  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of the mocked pg service stubbed with Jest  
**Example**  
```js
import initPGMock from 'postgresql-service/src/pg.mock';
import assert from 'assert';

const { service: pg, mocksClear } = await initPGMock();

// Let's returns Thomas birth date (OMG ya father
// talking me about its childrens :D).
pg.query.mockResolvedValueOnce({ rows: [[1]], fields: {}});

assert.deepEqual(pg.mock.calls, [[
   'SELECT 1'
]], 'Called once');

mocksClear();

assert.deepEqual(pg.mock.calls, []);
```
<a name="initPGService"></a>

## initPGService(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Instantiate the pg service

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of the pg service  

| Param | Type | Description |
| --- | --- | --- |
| services | <code>Object</code> | The services to inject |
| [services.log] | <code>function</code> | A logging function |
| [services.ENV] | <code>Object</code> | An environment object |
| services.PG | <code>Object</code> | A `pg` compatible configuration object |

**Example**  
```js
import initPGService from 'postgresql-service';

const { service: pg, dispose } = await initPGService({
  log: console.log.bind(console),
  ENV: process.env, // Proxy the PG_URL env var
});

const result = pg.query('SELECT 1');

await dispose();
```

* [initPGService(services)](#initPGService) ⇒ <code>Promise.&lt;Object&gt;</code>
    * [~query()](#initPGService..query) ⇒ <code>String</code> \| <code>Object</code>
    * [~queries()](#initPGService..queries) ⇒ <code>Array.&lt;String&gt;</code> \| <code>Object</code>
    * [~transaction()](#initPGService..transaction) ⇒ <code>Array.&lt;String&gt;</code> \| <code>Object</code>

<a name="initPGService..query"></a>

### initPGService~query() ⇒ <code>String</code> \| <code>Object</code>
Executes the given query

**Kind**: inner method of [<code>initPGService</code>](#initPGService)  
**Returns**: <code>String</code> - Query to execute<code>Object</code> - Arguments hash for the query  
**Example**  
```js
const { rows, fields } = await pg.query(
   'SELECT * FROM users WHERE user = $$userId',
   { userId: 1 }
);
```
<a name="initPGService..queries"></a>

### initPGService~queries() ⇒ <code>Array.&lt;String&gt;</code> \| <code>Object</code>
Executes the given queries in parallel (using the connections pool)

**Kind**: inner method of [<code>initPGService</code>](#initPGService)  
**Returns**: <code>Array.&lt;String&gt;</code> - Queries to execute<code>Object</code> - Arguments hashes for the queries  
**Example**  
```js
const [{ rows, fields }, { rows2, fields2 }] = await pg.queries([
   'SELECT * FROM users WHERE user = $$userId',
   'SELECT * FROM users WHERE user = $$userId',
], { userId: 1 });
```
<a name="initPGService..transaction"></a>

### initPGService~transaction() ⇒ <code>Array.&lt;String&gt;</code> \| <code>Object</code>
Executes the given queries in a single transaction

**Kind**: inner method of [<code>initPGService</code>](#initPGService)  
**Returns**: <code>Array.&lt;String&gt;</code> - Queries to execute<code>Object</code> - Arguments hashes for the queries  
**Example**  
```js
const [, { rows, fields }] = await pg.transaction([
   'UPDATE users SET isActive = true WHERE user = $$userId',
   'SELECT * FROM users WHERE user = $$userId',
], { userId: 1 });
```

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/postgresql-service/blob/master/LICENSE)
